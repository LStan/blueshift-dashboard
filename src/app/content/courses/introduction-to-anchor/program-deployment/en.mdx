import { ArticleSection } from "../../../../components/ArticleSection/ArticleSection";

# Program Deployment

Once your program is complete, you'll need to deploy it to devnet or mainnet to start interacting with it.

<ArticleSection name="Program Deployment" id="program-deployment" level="h2" />

Start by building the program: 

```
anchor build
```

This creates a target/deploy folder containing:
- `<project-name>.so`: your program's bytecode
- `<project-name>-keypair.json`: a generated keypair for deployment

> You can replace this keypair with a vanity address if desired by substituting the keypair in the `<project-name>-keypair.json` file.

At this point you need to grab the program address by doing:

```
solana address -k target/deploy/<project-name>-keypair.json
```

Update the `declare_id!()` function in the `lib.rs` to the right address and then update your `Anchor.toml` to specify the target cluster and program ID:

```
[provider]
cluster = "devnet"

[programs.devnet]
<project-name> = "<PROGRAM_ID>"
```

At this point, we're finally ready to deploy the program:

```
anchor deploy
```

This deploys your program using the specified address, cluster, and wallet from the `Anchor.toml` file as the fee payer.

### Deployment Fail

Program Deployment can fail. 

Failed deployments create intermediate buffer accounts that hold lamports. You'll see recovery instructions like:

```
==================================================================================
Recover the intermediate account's ephemeral keypair file with
`solana-keygen recover` and the following 12-word seed phrase:
==================================================================================
valley flat great hockey share token excess clever benefit traffic avocado athlete
==================================================================================
To resume a deploy, pass the recovered keypair as
the [BUFFER_SIGNER] to `solana program deploy` or `solana program write-buffer'.
Or to recover the account's lamports, pass it as the
[BUFFER_ACCOUNT_ADDRESS] argument to `solana program drain`.
==================================================================================
```

In order to recoup that balance you can: 

- Resume deployment recovering the keypair using:
    ```
    solana-keygen recover -o <KEYPAIR_PATH>
    ```
    when asked, enter the 12-word seed phrase and issue a new deploy command by specifying the buffer:
    ```
    solana program deploy ./target/deploy/<project-name>.so --program-id ./target/deploy/<project-name>-keypair.json --buffer ./target/deploy/<buffer>-keypair.json
    ```

- Close the buffer calling:
    ```
    solana program close <ADDRESS>
    ```

### Deployment through Solana CLI

You can deploy directly using the Solana CLI instead of Anchor:

```
solana program deploy ./target/deploy/<project-name>.so --program-id ./target/deploy/<project-name>-keypair.json
```

During network congestion, the deployment might fail, to increase the possibility of deployment use these flags:
- `--with-compute-unit-price`: Set compute unit price in micro-lamports per compute unit
- `--use-rpc`: Send transactions to RPC instead of validator TPUs
- `--max-sign-attempts`: Maximum retry attempts after blockhash expiration

<ArticleSection name="Program Upgrade" id="program-upgrade" level="h2" />

By default, `anchor deploy` creates a new program ID. To upgrade an existing program:

```
anchor upgrade target/deploy/<project-name>.so --program-id <PROGRAM_ID>
```

**If the new executable is larger than the deployed one, we need to extend the program account first:**

```
solana program extend ./target/deploy/<project-name>.so <ADDITIONAL_BYTES>
```

### Upgrade through Solana CLI

The process is the same: extend the program if needed, then deploy:

```
solana program deploy ./target/deploy/<project-name>.so --program-id ./target/deploy/<project-name>-keypair.json
```

### Making Programs Immutable

Remove the upgrade authority to make your program immutable:

```
solana program set-upgrade-authority <PROGRAM_ID> --final
```

> This action is irreversible.

### Migrating Programs

Migrating transfers a program from an old address to a new address. The CLI closes the old program and redeploys it to the new location:

```
solana program migrate ./target/deploy/<project-name>.json
```

> This "breaks" all existing PDAs since they derive from the new Program ID.

<ArticleSection name="Uploading an IDL" id="uploading-an-idl" level="h2" />

An Interface Description Language (IDL) file provides a standardized JSON description of your program's instructions and accounts, simplifying client integration.

Upload the IDL on-chain to help others integrate your program:

```
anchor idl init --filepath target/idl/<program_name>.json <PROGRAM_ID>
```

### Upgrading the IDL

After redeploying your program, update the on-chain IDL:

```
anchor idl upgrade --filepath target/idl/<program_name>.json <PROGRAM_ID>
```


